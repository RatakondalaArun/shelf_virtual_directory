name: CD

on:
  release:
    types: [published]

jobs:
  publish:
    name: üì¶ Publish package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4

      - name: üîß Setup Dart SDK
        uses: dart-lang/setup-dart@v1.0

      - name: ‚è¨ Get Depdendencies
        run: dart pub get

      - name: üß¨ Analyze
        run: dart analyze

      - name: ‚öô Setup Pub Creditionals
        shell: bash
        env:
          PUB_DEV_PUBLISH_ACCESS_TOKEN: ${{ secrets.PUB_DEV_PUBLISH_ACCESS_TOKEN }}
          PUB_DEV_PUBLISH_REFRESH_TOKEN: ${{ secrets.PUB_DEV_PUBLISH_REFRESH_TOKEN }}
          PUB_DEV_PUBLISH_TOKEN_ENDPOINT: ${{ secrets.PUB_DEV_PUBLISH_TOKEN_ENDPOINT }}
          PUB_DEV_PUBLISH_EXPIRATION: ${{ secrets.PUB_DEV_PUBLISH_EXPIRATION }}
        run: |
          cat <<EOF > ~/.pub-cache/credentials.json
          {
            "accessToken":"${PUB_DEV_PUBLISH_ACCESS_TOKEN}",
            "refreshToken":"${PUB_DEV_PUBLISH_REFRESH_TOKEN}",
            "tokenEndpoint":"${PUB_DEV_PUBLISH_TOKEN_ENDPOINT}",
            "scopes":["https://www.googleapis.com/auth/userinfo.email","openid"],
            "expiration":${PUB_DEV_PUBLISH_EXPIRATION}
          }
          EOF

      - name: üöÄ Publish
        run: dart pub publish -n && dart pub publish -f

  docs:
    needs: [publish]
    name: Generate docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4

      - name: üìê Setup Dart SDK
        uses: dart-lang/setup-dart@v1.0

      - name: üß¨ Generate docs
        run: dartdoc --output docs

      - name: üå≥ tree
        run: tree

      - name: üì¢ Publish docs
        uses: JamesIves/github-pages-deploy-action@4.1.2
        with:
          branch: docs
          folder: docs
